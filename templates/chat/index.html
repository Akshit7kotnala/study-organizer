{% extends "base.html" %}
{% block title %}AI Study Assistant - Study Organizer{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar with chat sessions -->
    <div class="col-md-3 border-end" style="height: calc(100vh - 80px); overflow-y: auto;">
      <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">
            <i class="bi bi-chat-dots me-2"></i>
            Chat Sessions
          </h5>
          <button class="btn btn-sm btn-primary" onclick="createNewChat()">
            <i class="bi bi-plus-lg"></i> New
          </button>
        </div>

        <!-- New chat options -->
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title">Start New Chat</h6>
            <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="createGeneralChat()">
              <i class="bi bi-chat"></i> General Study Chat
            </button>
            <button class="btn btn-outline-success btn-sm w-100 mb-2" data-bs-toggle="modal" data-bs-target="#documentChatModal">
              <i class="bi bi-file-text"></i> Chat About Document
            </button>
            <button class="btn btn-outline-info btn-sm w-100 mb-2" data-bs-toggle="modal" data-bs-target="#quizModal">
              <i class="bi bi-question-circle"></i> Generate Quiz
            </button>
            <button class="btn btn-outline-warning btn-sm w-100" data-bs-toggle="modal" data-bs-target="#studyPlanModal">
              <i class="bi bi-calendar-check"></i> Create Study Plan
            </button>
          </div>
        </div>

        <!-- Chat history -->
        <div class="list-group">
          {% if sessions %}
            {% for session in sessions %}
            <a href="{{ url_for('chat_session', session_id=session.id) }}" 
               class="list-group-item list-group-item-action">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ session.title }}</h6>
                <small class="text-muted">{{ session.message_count() }}</small>
              </div>
              <small class="text-muted">
                {% if session.document %}
                  <i class="bi bi-file-text"></i> {{ session.document.original_filename }}
                {% endif %}
                <br>
                {{ session.updated_at.strftime('%b %d, %Y %I:%M %p') }}
              </small>
            </a>
            {% endfor %}
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
              <p class="mt-2">No chat sessions yet.<br>Start a new conversation!</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Main content area -->
    <div class="col-md-9 d-flex flex-column align-items-center justify-content-center" style="height: calc(100vh - 80px);">
      <div class="text-center">
        <i class="bi bi-robot" style="font-size: 5rem; color: var(--primary-color);"></i>
        <h2 class="mt-4 mb-3">AI Study Assistant</h2>
        <p class="lead text-muted mb-4">Your intelligent companion for studying smarter</p>
        
        <div class="row g-3 mt-4" style="max-width: 600px;">
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-body">
                <i class="bi bi-chat-quote text-primary" style="font-size: 2rem;"></i>
                <h5 class="mt-3">Chat with Documents</h5>
                <p class="text-muted small">Ask questions about your study materials and get instant answers</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-body">
                <i class="bi bi-patch-question text-success" style="font-size: 2rem;"></i>
                <h5 class="mt-3">Generate Quizzes</h5>
                <p class="text-muted small">Auto-create practice questions from your documents</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-body">
                <i class="bi bi-calendar-check text-info" style="font-size: 2rem;"></i>
                <h5 class="mt-3">Study Plans</h5>
                <p class="text-muted small">Get personalized study schedules based on your goals</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-body">
                <i class="bi bi-lightbulb text-warning" style="font-size: 2rem;"></i>
                <h5 class="mt-3">Smart Insights</h5>
                <p class="text-muted small">Get summaries, key points, and study tips</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <button class="btn btn-primary btn-lg" onclick="createGeneralChat()">
            <i class="bi bi-chat-dots"></i> Start Chatting Now
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Document Chat Modal -->
<div class="modal fade" id="documentChatModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chat About a Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Select a document to chat about:</p>
        <select class="form-select" id="documentSelect">
          <option value="">Loading documents...</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createDocumentChat()">Start Chat</button>
      </div>
    </div>
  </div>
</div>

<!-- Quiz Modal -->
<div class="modal fade" id="quizModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate Quiz</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Select Document</label>
          <select class="form-select" id="quizDocumentSelect">
            <option value="">Loading documents...</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Number of Questions</label>
          <input type="number" class="form-control" id="numQuestions" value="5" min="1" max="20">
        </div>
        <div class="mb-3">
          <label class="form-label">Difficulty</label>
          <select class="form-select" id="difficulty">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="generateQuiz()">Generate Quiz</button>
      </div>
    </div>
  </div>
</div>

<!-- Study Plan Modal -->
<div class="modal fade" id="studyPlanModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Study Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Study Goal</label>
          <input type="text" class="form-control" id="studyGoal" placeholder="e.g., Prepare for final exams">
        </div>
        <div class="mb-3">
          <label class="form-label">Duration (days)</label>
          <input type="number" class="form-control" id="durationDays" value="7" min="1" max="30">
        </div>
        <div class="mb-3">
          <label class="form-label">Hours per Day</label>
          <input type="number" class="form-control" id="hoursPerDay" value="2" min="1" max="12">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="generateStudyPlan()">Create Plan</button>
      </div>
    </div>
  </div>
</div>

<script>
// Load documents on page load
document.addEventListener('DOMContentLoaded', function() {
  loadDocuments();
});

function loadDocuments() {
  fetch('/api/documents')
    .then(response => response.json())
    .then(data => {
      const docSelect = document.getElementById('documentSelect');
      const quizDocSelect = document.getElementById('quizDocumentSelect');
      
      docSelect.innerHTML = '<option value="">Choose a document...</option>';
      quizDocSelect.innerHTML = '<option value="">Choose a document...</option>';
      
      data.documents.forEach(doc => {
        const option1 = new Option(doc.original_filename, doc.id);
        const option2 = new Option(doc.original_filename, doc.id);
        docSelect.add(option1);
        quizDocSelect.add(option2);
      });
    });
}

function createGeneralChat() {
  fetch('/chat/new', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ title: 'General Study Chat' })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = data.redirect_url;
    }
  });
}

function createDocumentChat() {
  const docId = document.getElementById('documentSelect').value;
  if (!docId) {
    alert('Please select a document');
    return;
  }
  
  fetch('/chat/new', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ document_id: parseInt(docId) })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = data.redirect_url;
    }
  });
}

function generateQuiz() {
  const docId = document.getElementById('quizDocumentSelect').value;
  const numQuestions = document.getElementById('numQuestions').value;
  const difficulty = document.getElementById('difficulty').value;
  
  if (!docId) {
    alert('Please select a document');
    return;
  }
  
  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
  
  fetch('/chat/quiz/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      document_id: parseInt(docId),
      num_questions: parseInt(numQuestions),
      difficulty: difficulty
    })
  })
  .then(response => response.json())
  .then(data => {
    btn.disabled = false;
    btn.innerHTML = 'Generate Quiz';
    
    if (data.success) {
      // Store quiz data and redirect
      sessionStorage.setItem('quizData', JSON.stringify(data.quiz));
      bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();
      // You can create a quiz page or show results in a modal
      alert('Quiz generated! Check the console for now (will create dedicated page next)');
      console.log('Quiz:', data.quiz);
    } else {
      alert('Error: ' + data.error);
    }
  });
}

function generateStudyPlan() {
  const goal = document.getElementById('studyGoal').value;
  const duration = document.getElementById('durationDays').value;
  const hours = document.getElementById('hoursPerDay').value;
  
  if (!goal) {
    alert('Please enter a study goal');
    return;
  }
  
  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
  
  fetch('/chat/study-plan/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      goal: goal,
      duration_days: parseInt(duration),
      hours_per_day: parseInt(hours)
    })
  })
  .then(response => response.json())
  .then(data => {
    btn.disabled = false;
    btn.innerHTML = 'Create Plan';
    
    if (data.success) {
      // Store plan and show
      sessionStorage.setItem('studyPlan', JSON.stringify(data.study_plan));
      bootstrap.Modal.getInstance(document.getElementById('studyPlanModal')).hide();
      alert('Study plan created! Check console (will create dedicated page next)');
      console.log('Study Plan:', data.study_plan);
    } else {
      alert('Error: ' + data.error);
    }
  });
}
</script>
{% endblock %}
