{% extends "base.html" %}
{% block title %}{{ session.title }} - AI Study Assistant{% endblock %}

{% block content %}
<style>
.chat-container {
  height: calc(100vh - 140px);
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 1rem;
  background: var(--card-bg);
  border-bottom: 1px solid var(--border-color);
}

.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  background: var(--body-bg);
}

.message {
  margin-bottom: 1.5rem;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-user {
  display: flex;
  justify-content: flex-end;
}

.message-assistant {
  display: flex;
  justify-content: flex-start;
}

.message-bubble {
  max-width: 70%;
  padding: 1rem 1.25rem;
  border-radius: 1rem;
  box-shadow: var(--shadow-sm);
}

.message-user .message-bubble {
  background: var(--primary-color);
  color: white;
  border-bottom-right-radius: 0.25rem;
}

.message-assistant .message-bubble {
  background: var(--card-bg);
  color: var(--text-primary);
  border-bottom-left-radius: 0.25rem;
  border: 1px solid var(--border-color);
}

.message-meta {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
}

.typing-indicator {
  display: none;
  padding: 1rem 1.25rem;
  background: var(--card-bg);
  border-radius: 1rem;
  border: 1px solid var(--border-color);
  max-width: 70px;
}

.typing-indicator span {
  height: 8px;
  width: 8px;
  background: var(--text-muted);
  border-radius: 50%;
  display: inline-block;
  margin: 0 2px;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-10px); }
}

.chat-input-container {
  padding: 1rem;
  background: var(--card-bg);
  border-top: 1px solid var(--border-color);
}

.document-context-card {
  background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
  border-left: 4px solid var(--primary-color);
}
</style>

<div class="chat-container">
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">
          <i class="bi bi-chat-dots me-2"></i>
          {{ session.title }}
        </h5>
        {% if document %}
        <small class="text-muted">
          <i class="bi bi-file-text"></i> {{ document.original_filename }}
          <span class="badge bg-secondary ms-2">{{ document.subject }}</span>
        </small>
        {% endif %}
      </div>
      <div>
        <a href="{{ url_for('chat_index') }}" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back
        </a>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteChat()">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Document Context Card (if applicable) -->
  {% if document %}
  <div class="px-3 pt-3">
    <div class="card document-context-card">
      <div class="card-body py-2">
        <div class="row align-items-center">
          <div class="col">
            <small>
              <strong><i class="bi bi-info-circle"></i> Document Context:</strong>
              {{ document.original_filename }} ({{ document.year }} Year, {{ document.subject }})
            </small>
          </div>
          <div class="col-auto">
            {% if document.summary %}
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#summaryCollapse">
              <i class="bi bi-book"></i> View Summary
            </button>
            {% endif %}
          </div>
        </div>
        {% if document.summary %}
        <div class="collapse mt-2" id="summaryCollapse">
          <small class="text-muted">{{ document.summary }}</small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Messages Container -->
  <div class="messages-container" id="messagesContainer">
    {% if messages %}
      {% for msg in messages %}
      <div class="message message-{{ msg.role }}">
        <div class="message-bubble">
          <div class="message-content">{{ msg.content }}</div>
          <div class="message-meta">
            {{ msg.created_at.strftime('%I:%M %p') }}
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="text-center text-muted py-5">
        <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
        <p class="mt-3">Start a conversation with your AI Study Assistant!</p>
        <p class="small">Ask questions, request summaries, or generate practice questions.</p>
      </div>
    {% endif %}

    <!-- Typing Indicator -->
    <div class="message message-assistant" id="typingIndicator">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <!-- Chat Input -->
  <div class="chat-input-container">
    <form id="chatForm" onsubmit="sendMessage(event)">
      <div class="input-group">
        <input 
          type="text" 
          class="form-control" 
          id="messageInput" 
          placeholder="Ask me anything about your studies..." 
          autocomplete="off"
          required
        >
        <button class="btn btn-primary" type="submit" id="sendButton">
          <i class="bi bi-send"></i> Send
        </button>
      </div>
    </form>
    
    <!-- Quick Actions -->
    <div class="mt-2">
      <small class="text-muted">Quick actions:</small>
      <div class="btn-group btn-group-sm ms-2" role="group">
        <button class="btn btn-outline-secondary" onclick="quickPrompt('Summarize the key points')">
          <i class="bi bi-list-ul"></i> Summarize
        </button>
        <button class="btn btn-outline-secondary" onclick="quickPrompt('Create 5 quiz questions')">
          <i class="bi bi-question-circle"></i> Quiz Me
        </button>
        <button class="btn btn-outline-secondary" onclick="quickPrompt('Explain this in simple terms')">
          <i class="bi bi-lightbulb"></i> Explain
        </button>
        <button class="btn btn-outline-secondary" onclick="quickPrompt('What are the main topics covered?')">
          <i class="bi bi-tags"></i> Topics
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const sessionId = {{ session.id }};
const messagesContainer = document.getElementById('messagesContainer');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');

// Auto-scroll to bottom
function scrollToBottom() {
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Initial scroll
scrollToBottom();

// Send message
function sendMessage(event) {
  event.preventDefault();
  
  const message = messageInput.value.trim();
  if (!message) return;
  
  // Disable input
  messageInput.disabled = true;
  sendButton.disabled = true;
  
  // Add user message to UI
  addMessageToUI('user', message);
  
  // Clear input
  messageInput.value = '';
  
  // Show typing indicator
  typingIndicator.style.display = 'flex';
  scrollToBottom();
  
  // Send to server
  fetch(`/chat/${sessionId}/message`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ message: message })
  })
  .then(response => response.json())
  .then(data => {
    // Hide typing indicator
    typingIndicator.style.display = 'none';
    
    if (data.success) {
      // Add AI response to UI
      addMessageToUI('assistant', data.ai_message.content);
    } else {
      alert('Error: ' + data.error);
    }
    
    // Re-enable input
    messageInput.disabled = false;
    sendButton.disabled = false;
    messageInput.focus();
    scrollToBottom();
  })
  .catch(error => {
    typingIndicator.style.display = 'none';
    alert('Network error. Please try again.');
    messageInput.disabled = false;
    sendButton.disabled = false;
  });
}

// Add message to UI
function addMessageToUI(role, content) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message message-${role}`;
  
  const now = new Date();
  const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  
  messageDiv.innerHTML = `
    <div class="message-bubble">
      <div class="message-content">${escapeHtml(content)}</div>
      <div class="message-meta">${time}</div>
    </div>
  `;
  
  // Insert before typing indicator
  messagesContainer.insertBefore(messageDiv, typingIndicator);
  scrollToBottom();
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML.replace(/\n/g, '<br>');
}

// Quick prompt
function quickPrompt(text) {
  messageInput.value = text;
  messageInput.focus();
}

// Delete chat
function deleteChat() {
  if (!confirm('Are you sure you want to delete this chat session?')) return;
  
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/chat/${sessionId}/delete`;
  document.body.appendChild(form);
  form.submit();
}

// Focus input on load
messageInput.focus();
</script>
{% endblock %}
